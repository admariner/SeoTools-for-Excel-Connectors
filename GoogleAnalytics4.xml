<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="SEO" RequireVersion="9.0" Title="Google Analytics 4" Id="GoogleAnalytics4" LoginButton="https://seotoolsforexcel.com/logins/google.png" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/GoogleAnalytics4.xml" HelpUrl="http://seotoolsforexcel.com/googleanalytics4/" HelpText="Documentation">

  <Author Name="Victor" Url="http://community.seotoolsforexcel.com/users/diskborste/activity"/>

  <GoogleOAuth2Authenticator ClientId="" ClientSecret="" Scope="https://www.googleapis.com/auth/analytics.readonly" StayAuthenticated="true"/>

  <Resources>
		<Resource Id="Metrics">
			<Item Id="active1DayUsers"/>
			<Item Id="active28DayUsers"/>
			<Item Id="active7DayUsers"/>
			<Item Id="activeUsers"/>
			<Item Id="adUnitExposure"/>
			<Item Id="addToCarts"/>
			<Item Id="advertiserAdClicks"/>
			<Item Id="advertiserAdCost"/>
			<Item Id="advertiserAdCostPerClick"/>
			<Item Id="advertiserAdCostPerConversion"/>
			<Item Id="advertiserAdImpressions"/>
			<Item Id="averagePurchaseRevenue"/>
			<Item Id="averagePurchaseRevenuePerPayingUser"/>
			<Item Id="averagePurchaseRevenuePerUser"/>
			<Item Id="averageRevenuePerUser"/>
			<Item Id="averageSessionDuration"/>
			<Item Id="bounceRate"/>
			<Item Id="cartToViewRate"/>
			<Item Id="checkouts"/>
			<Item Id="cohortActiveUsers"/>
			<Item Id="cohortTotalUsers"/>
			<Item Id="conversions"/>
			<Item Id="crashAffectedUsers"/>
			<Item Id="crashFreeUsersRate"/>
			<Item Id="dauPerMau"/>
			<Item Id="dauPerWau"/>
			<Item Id="ecommercePurchases"/>
			<Item Id="engagedSessions"/>
			<Item Id="engagementRate"/>
			<Item Id="eventCount"/>
			<Item Id="eventCountPerUser"/>
			<Item Id="eventValue"/>
			<Item Id="eventsPerSession"/>
			<Item Id="firstTimePurchaserConversionRate"/>
			<Item Id="firstTimePurchasers"/>
			<Item Id="firstTimePurchasersPerNewUser"/>
			<Item Id="itemListClickEvents"/>
			<Item Id="itemListClickThroughRate"/>
			<Item Id="itemListViewEvents"/>
			<Item Id="itemPromotionClickThroughRate"/>
			<Item Id="itemRevenue"/>
			<Item Id="itemViewEvents"/>
			<Item Id="itemsAddedToCart"/>
			<Item Id="itemsCheckedOut"/>
			<Item Id="itemsClickedInList"/>
			<Item Id="itemsClickedInPromotion"/>
			<Item Id="itemsPurchased"/>
			<Item Id="itemsViewed"/>
			<Item Id="itemsViewedInList"/>
			<Item Id="itemsViewedInPromotion"/>
			<Item Id="newUsers"/>
			<Item Id="organicGoogleSearchAveragePosition"/>
			<Item Id="organicGoogleSearchClickThroughRate"/>
			<Item Id="organicGoogleSearchClicks"/>
			<Item Id="organicGoogleSearchImpressions"/>
			<Item Id="promotionClicks"/>
			<Item Id="promotionViews"/>
			<Item Id="publisherAdClicks"/>
			<Item Id="publisherAdImpressions"/>
			<Item Id="purchaseRevenue"/>
			<Item Id="purchaseToViewRate"/>
			<Item Id="purchaserConversionRate"/>
			<Item Id="returnOnAdSpend"/>
			<Item Id="screenPageViews"/>
			<Item Id="screenPageViewsPerSession"/>
			<Item Id="screenPageViewsPerUser"/>
			<Item Id="scrolledUsers"/>
			<Item Id="sessionConversionRate"/>
			<Item Id="sessions"/>
			<Item Id="sessionsPerUser"/>
			<Item Id="shippingAmount"/>
			<Item Id="taxAmount"/>
			<Item Id="totalAdRevenue"/>
			<Item Id="totalPurchasers"/>
			<Item Id="totalRevenue"/>
			<Item Id="totalUsers"/>
			<Item Id="transactions"/>
			<Item Id="transactionsPerPurchaser"/>
			<Item Id="userConversionRate"/>
			<Item Id="userEngagementDuration"/>
			<Item Id="wauPerMau"/>
		</Resource>
		<Resource Id="Dimensions">
			<Item Id="achievementId"/>
			<Item Id="adFormat"/>
			<Item Id="adSourceName"/>
			<Item Id="adUnitName"/>
			<Item Id="appVersion"/>
			<Item Id="audienceId"/>
			<Item Id="audienceName"/>
			<Item Id="brandingInterest"/>
			<Item Id="browser"/>
			<Item Id="campaignId"/>
			<Item Id="campaignName"/>
			<Item Id="character"/>
			<Item Id="city"/>
			<Item Id="cityId"/>
			<Item Id="cohort"/>
			<Item Id="cohortNthDay"/>
			<Item Id="cohortNthMonth"/>
			<Item Id="cohortNthWeek"/>
			<Item Id="contentGroup"/>
			<Item Id="contentId"/>
			<Item Id="contentType"/>
			<Item Id="continent"/>
			<Item Id="continentId"/>
			<Item Id="country"/>
			<Item Id="countryId"/>
			<Item Id="date"/>
			<Item Id="dateHour"/>
			<Item Id="dateHourMinute"/>
			<Item Id="day"/>
			<Item Id="dayOfWeek"/>
			<Item Id="dayOfWeekName"/>
			<Item Id="defaultChannelGroup"/>
			<Item Id="deviceCategory"/>
			<Item Id="deviceModel"/>
			<Item Id="eventName"/>
			<Item Id="fileExtension"/>
			<Item Id="fileName"/>
			<Item Id="firstSessionDate"/>
			<Item Id="firstUserCampaignId"/>
			<Item Id="firstUserCampaignName"/>
			<Item Id="firstUserDefaultChannelGroup"/>
			<Item Id="firstUserGoogleAdsAccountName"/>
			<Item Id="firstUserGoogleAdsAdGroupId"/>
			<Item Id="firstUserGoogleAdsAdGroupName"/>
			<Item Id="firstUserGoogleAdsAdNetworkType"/>
			<Item Id="firstUserGoogleAdsCampaignId"/>
			<Item Id="firstUserGoogleAdsCampaignName"/>
			<Item Id="firstUserGoogleAdsCampaignType"/>
			<Item Id="firstUserGoogleAdsCreativeId"/>
			<Item Id="firstUserGoogleAdsCustomerId"/>
			<Item Id="firstUserGoogleAdsKeyword"/>
			<Item Id="firstUserGoogleAdsQuery"/>
			<Item Id="firstUserManualAdContent"/>
			<Item Id="firstUserManualTerm"/>
			<Item Id="firstUserMedium"/>
			<Item Id="firstUserSource"/>
			<Item Id="firstUserSourceMedium"/>
			<Item Id="firstUserSourcePlatform"/>
			<Item Id="fullPageUrl"/>
			<Item Id="googleAdsAccountName"/>
			<Item Id="googleAdsAdGroupId"/>
			<Item Id="googleAdsAdGroupName"/>
			<Item Id="googleAdsAdNetworkType"/>
			<Item Id="googleAdsCampaignId"/>
			<Item Id="googleAdsCampaignName"/>
			<Item Id="googleAdsCampaignType"/>
			<Item Id="googleAdsCreativeId"/>
			<Item Id="googleAdsCustomerId"/>
			<Item Id="googleAdsKeyword"/>
			<Item Id="googleAdsQuery"/>
			<Item Id="groupId"/>
			<Item Id="hostName"/>
			<Item Id="hour"/>
			<Item Id="isConversionEvent"/>
			<Item Id="isoWeek"/>
			<Item Id="isoYear"/>
			<Item Id="isoYearIsoWeek"/>
			<Item Id="itemAffiliation"/>
			<Item Id="itemBrand"/>
			<Item Id="itemCategory"/>
			<Item Id="itemCategory2"/>
			<Item Id="itemCategory3"/>
			<Item Id="itemCategory4"/>
			<Item Id="itemCategory5"/>
			<Item Id="itemId"/>
			<Item Id="itemListId"/>
			<Item Id="itemListName"/>
			<Item Id="itemListPosition"/>
			<Item Id="itemLocationID"/>
			<Item Id="itemName"/>
			<Item Id="itemPromotionCreativeName"/>
			<Item Id="itemPromotionCreativeSlot"/>
			<Item Id="itemPromotionId"/>
			<Item Id="itemPromotionName"/>
			<Item Id="itemVariant"/>
			<Item Id="landingPagePlusQueryString"/>
			<Item Id="language"/>
			<Item Id="languageCode"/>
			<Item Id="level"/>
			<Item Id="linkClasses"/>
			<Item Id="linkDomain"/>
			<Item Id="linkId"/>
			<Item Id="linkText"/>
			<Item Id="linkUrl"/>
			<Item Id="manualAdContent"/>
			<Item Id="manualTerm"/>
			<Item Id="medium"/>
			<Item Id="method"/>
			<Item Id="minute"/>
			<Item Id="mobileDeviceBranding"/>
			<Item Id="mobileDeviceMarketingName"/>
			<Item Id="mobileDeviceModel"/>
			<Item Id="month"/>
			<Item Id="newVsReturning"/>
			<Item Id="nthDay"/>
			<Item Id="nthHour"/>
			<Item Id="nthMinute"/>
			<Item Id="nthMonth"/>
			<Item Id="nthWeek"/>
			<Item Id="nthYear"/>
			<Item Id="operatingSystem"/>
			<Item Id="operatingSystemVersion"/>
			<Item Id="operatingSystemWithVersion"/>
			<Item Id="orderCoupon"/>
			<Item Id="outbound"/>
			<Item Id="pageLocation"/>
			<Item Id="pagePath"/>
			<Item Id="pagePathPlusQueryString"/>
			<Item Id="pageReferrer"/>
			<Item Id="pageTitle"/>
			<Item Id="percentScrolled"/>
			<Item Id="platform"/>
			<Item Id="platformDeviceCategory"/>
			<Item Id="region"/>
			<Item Id="screenResolution"/>
			<Item Id="searchTerm"/>
			<Item Id="sessionCampaignId"/>
			<Item Id="sessionCampaignName"/>
			<Item Id="sessionDefaultChannelGroup"/>
			<Item Id="sessionGoogleAdsAccountName"/>
			<Item Id="sessionGoogleAdsAdGroupId"/>
			<Item Id="sessionGoogleAdsAdGroupName"/>
			<Item Id="sessionGoogleAdsAdNetworkType"/>
			<Item Id="sessionGoogleAdsCampaignId"/>
			<Item Id="sessionGoogleAdsCampaignName"/>
			<Item Id="sessionGoogleAdsCampaignType"/>
			<Item Id="sessionGoogleAdsCreativeId"/>
			<Item Id="sessionGoogleAdsCustomerId"/>
			<Item Id="sessionGoogleAdsKeyword"/>
			<Item Id="sessionGoogleAdsQuery"/>
			<Item Id="sessionManualAdContent"/>
			<Item Id="sessionManualTerm"/>
			<Item Id="sessionMedium"/>
			<Item Id="sessionSa360AdGroupName"/>
			<Item Id="sessionSa360CampaignId"/>
			<Item Id="sessionSa360CampaignName"/>
			<Item Id="sessionSa360CreativeFormat"/>
			<Item Id="sessionSa360EngineAccountId"/>
			<Item Id="sessionSa360EngineAccountName"/>
			<Item Id="sessionSa360EngineAccountType"/>
			<Item Id="sessionSa360Keyword"/>
			<Item Id="sessionSa360Medium"/>
			<Item Id="sessionSa360Query"/>
			<Item Id="sessionSa360Source"/>
			<Item Id="sessionSource"/>
			<Item Id="sessionSourceMedium"/>
			<Item Id="sessionSourcePlatform"/>
			<Item Id="shippingTier"/>
			<Item Id="signedInWithUserId"/>
			<Item Id="source"/>
			<Item Id="sourceMedium"/>
			<Item Id="sourcePlatform"/>
			<Item Id="streamId"/>
			<Item Id="streamName"/>
			<Item Id="testDataFilterId"/>
			<Item Id="testDataFilterName"/>
			<Item Id="transactionId"/>
			<Item Id="unifiedPagePathScreen"/>
			<Item Id="unifiedPageScreen"/>
			<Item Id="unifiedScreenClass"/>
			<Item Id="unifiedScreenName"/>
			<Item Id="userAgeBracket"/>
			<Item Id="userGender"/>
			<Item Id="videoProvider"/>
			<Item Id="videoTitle"/>
			<Item Id="videoUrl"/>
			<Item Id="virtualCurrencyName"/>
			<Item Id="visible"/>
			<Item Id="week"/>
			<Item Id="year"/>
			<Item Id="yearMonth"/>
			<Item Id="yearWeek"/>
		</Resource>
    <Resource Id="HttpSettingsHeaders">
			<RequestHeaders>
				<Header Name='Authorization'><![CDATA[Bearer @(Model.Authenticator.AccessToken)]]></Header>
			</RequestHeaders>
    </Resource>
    <Resource Id="Fail">
			<Fail>
				<Xpath Expr="//title"/>
				<JsonPath Expr="error.message"/>
			</Fail>
    </Resource>
  </Resources>

  <RestConnector Id="PropertiesList" Title="Properties" HelpUrl="https://developers.google.com/analytics/devguides/config/admin/v1/rest/v1beta/accounts/list" Hidden="true">
    <Fetch>
      <HttpSettings>
				<Resource Id="HttpSettingsHeaders"/>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        https://analyticsadmin.googleapis.com/v1beta/accountSummaries
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
			<XPath Expr="//propertySummaries">
				<Compute Id="PropertyId" Title="Property Id">
					<Compute.Expr>
						<![CDATA[
						@Model.Inp.Replace("properties/","")
						]]>
					</Compute.Expr>
					<XPath Expr="property" Id="Inp"/>
				</Compute>

				<XPath Expr="displayName" Id="Property Name"/>
				<XPath Expr="../displayName" Id="Account Name"/>
			</XPath>
    </Parse>
		<Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="AccountsList" Title="Accounts" HelpUrl="https://developers.google.com/analytics/devguides/config/admin/v1/rest/v1beta/accounts/list" Hidden="true">
    <Fetch>
      <HttpSettings>
				<Resource Id="HttpSettingsHeaders"/>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        https://analyticsadmin.googleapis.com/v1beta/accounts
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
			<JsonPath Expr="accounts[*]">
				<JsonPath Expr="name" Id="AccountId" Title="Account Id" Converter="String"/>
				<JsonPath Expr="displayName" Id="DisplayName" Title="Display Name" Converter="String"/>
				<JsonPath Expr="createTime" Id="Created" Title="Created" Converter="DateTime"/>
				<JsonPath Expr="regionCode" Id="Region" Title="Region" Converter="String"/>
			</JsonPath>
    </Parse>
		<Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="PropertiesList" Title="Properties" HelpUrl="https://developers.google.com/analytics/devguides/config/admin/v1/rest/v1beta/properties/list" Hidden="true">
    <Parameters>
      <Text Id="AccountId" Title="Account Id" Required="true" Debug.DefaultValue="accounts/35565608" Select.Connector="AccountsList"/>
    </Parameters>
    <Fetch>
      <HttpSettings>
				<Resource Id="HttpSettingsHeaders"/>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        https://analyticsadmin.googleapis.com/v1beta/properties
				?filter=parent:@Model.AccountId
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
			<JsonPath Expr="properties[*]">
				<JsonPath Expr="name" Id="PropertyId" Title="Property Id" Converter="String"/>
				<JsonPath Expr="displayName" Id="DisoplayName" Title="Display Name" Converter="String"/>
				<JsonPath Expr="createTime" Id="Created" Title="Created" Converter="DateTime"/>
			</JsonPath>
    </Parse>
		<Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="RunReport" Title="RunReport" HelpUrl="">
    <Parameters>
			<!--
      <Text Id="AccountId" Title="Account Id" Required="true" Debug.DefaultValue="accounts/35565608" Select.Connector="AccountsList"/>
      <Text Id="PropertyId" Title="Property Id" Required="true" Debug.DefaultValue="properties/358884326" Select.Connector="PropertiesList"/>
			-->
      <Text Id="PropertyId" Title="Property Id" Required="true" Debug.DefaultValue="358884326" Select.Connector="PropertiesList"/>
			<ListBox Id="Metrics" Title="Metrics" AllChecked="false" Required="true">
				<DataSource>
					<Resource Id="Metrics"/>
				</DataSource>
      </ListBox>
			<ListBox Id="Dimensions" Title="Dimensions" AllChecked="false" Required="false">
        <DataSource>
					<Resource Id="Dimensions"/>
        </DataSource>
      </ListBox>
			<Checkbox Id="KeepEmptyRows" Title="Keep Empty Rows" DefaultValue="True" HelpText="If false, each row with all metrics equal to 0 will not be returned. If true, these rows will be returned if they are not separately removed by a filter."/>
			<DateInterval Id="DateInterval" Title="Date Interval"/>
    </Parameters>
		<Paging PageSize="1000" EvenPages="false">
			<Parse>
				<JsonPath Expr="$.rowCount" Id="AvaliableRows"/>
			</Parse>
		</Paging>
		<Fetch>
      <HttpSettings>
				<Resource Id="HttpSettingsHeaders"/>
        <RequestMethod>POST</RequestMethod>
        <RequestBody>
          <![CDATA[
					@jsonBody()
          ]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        https://analyticsdata.googleapis.com/v1beta/properties/@(Model.PropertyId):runReport
        ]]>
      </Fetch.Url>
			<!--
      <Fetch.Url>
        <![CDATA[
        file:///C:\Users\victor.sandberg\Downloads\ga_response.json
        ]]>
      </Fetch.Url>
			-->
    </Fetch>
    <Parse>
      <Table DefaultConverter="auto">
        <JsonPath Id="Headers" Expr="..name">
						<JsonPath Expr="$"/>
        </JsonPath>
        <JsonPath Id="Cells" Expr="..value" DefaultValue="">
          <JsonPath Expr="$"/>
        </JsonPath>
      </Table>
    </Parse>
		<Resource Id="Fail"/>
  </RestConnector>

  <RazorFunctions>
    <![CDATA[
		string jsonBody() {
			var jsonObject = new
			{
				metrics = GetMetricsObject(),
				dimensions = GetDimensionsObject(),
				dateRanges = GetDateRanges(),
				limit = @Model.PageCursor.NextTake,
				offset = @Model.PageCursor.NextSkip,
				keepEmptyRows = Model.KeepEmptyRows
			};

			return JsonConvert.SerializeObject(jsonObject, Formatting.Indented);
		}

		object GetMetricsObject() {
			string[] metricNames = ((string)Model.Metrics.Values).Split(',').ToArray();
			var metricObjects = new List<object>();

			foreach (var metricName in metricNames)
			{
				var metricObject = new { name = metricName };
				metricObjects.Add(metricObject);
			}

			return metricObjects;
		}

		object GetDimensionsObject() {
			if(Model.Dimensions.Values.Length == 0) return null;
			string[] dimensionsNames = ((string)Model.Dimensions.Values).Split(',').ToArray();

			var dimensionsObjects = new List<object>();

			foreach (var dimensionName in dimensionsNames)
			{
				var dimensionObject = new { name = dimensionName };
				dimensionsObjects.Add(dimensionObject);
			}

			return dimensionsObjects;
		}

		object GetDateRanges() {
			return new Dictionary<string, string>
			{
				{ "startDate", (((DateTimeOffset)Model.DateInterval.StartDate).ToString("yyyy-MM-dd")) },
				{ "endDate", (((DateTimeOffset)Model.DateInterval.EndDate).ToString("yyyy-MM-dd")) },
				{ "name", "period" }
			};
		}
    ]]>
  </RazorFunctions>

</Suite>